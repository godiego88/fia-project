name: FIA Continuous Integrity

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  replay-stage1:
    name: Stage 1 Replay Harness
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # Checkout repository
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Check for Stage 1 replay fixtures
      # -------------------------
      - name: Check for Stage 1 replay fixtures
        id: check_stage1_replay
        run: |
          if [ -d tests/replay/fixtures ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # -------------------------
      # Exit silently if no fixtures
      # -------------------------
      - name: No Stage 1 replay fixtures — exit successfully
        if: steps.check_stage1_replay.outputs.exists == 'false'
        run: |
          echo "No Stage 1 replay fixtures found. Skipping Stage 1 replay (silence is success)."
          exit 0

      # -------------------------
      # Set up Python
      # -------------------------
      - name: Set up Python
        if: steps.check_stage1_replay.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------
      # Install dependencies
      # -------------------------
      - name: Install dependencies
        if: steps.check_stage1_replay.outputs.exists == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pytest jsonschema requests supabase pyyaml

      # -------------------------
      # Run Stage 1 replay harness
      # -------------------------
      - name: Run Stage 1 replay harness
        if: steps.check_stage1_replay.outputs.exists == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          pytest tests/replay/test_stage1_replay.py

  replay-stage2:
    name: Stage 2 Replay Harness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for trigger context
        id: check_trigger
        run: |
          if [ -f trigger_context.json ]; then
            echo "trigger_exists=true" >> $GITHUB_OUTPUT
          else
            echo "trigger_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: No trigger — exit successfully
        if: steps.check_trigger.outputs.trigger_exists == 'false'
        run: |
          echo "No trigger_context.json found. Skipping Stage 2 replay (silence is success)."
          exit 0

      - name: Set up Python
        if: steps.check_trigger.outputs.trigger_exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_trigger.outputs.trigger_exists == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pytest jsonschema requests supabase

      - name: Run Stage 2 replay harness
        if: steps.check_trigger.outputs.trigger_exists == 'true'
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          pytest tests/replay/test_stage2_replay.py
